<!DOCTYPE html>
<html lang="en" class="text-slate-800 bg-slate-50">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Food Diary</title>
    <link rel="stylesheet" href="/main.css" />
    <script src="/main.js"></script>
  </head>

  <body>
    <div id="root"></div>
    <script>
      var app = Elm.Main.init({
        node: document.getElementById("root"),
        flags: {
          bytes: rememberedBytes(),
          credentials: storedCredentials(),
        },
      });

      /* Fetch back generated bytes from the local storage */
      function rememberedBytes() {
        const bytes = localStorage.getItem("bytes");
        return bytes ? bytes.split(",").map((x) => parseInt(x, 10)) : null;
      }

      /* Generate high entropy random bytes using the Web Crypto API and
       		 remember them so that they are preserved between redirections. This
       		 allows to protect for XSS & authorization code attacks
      */
      app.ports.genRandomBytes.subscribe((n) => {
        const buffer = new Uint8Array(n);
        crypto.getRandomValues(buffer);
        const bytes = Array.from(buffer);
        localStorage.setItem("bytes", bytes);
        app.ports.randomBytes.send(bytes);
      });

      function storedCredentials() {
        const creds = localStorage.getItem("food-diary-cached-credentials");
        if (creds) {
          const parsed = JSON.parse(creds);
          // five minute buffer to expiresAt
          if (parsed.expiresAt < new Date().getTime() - 1000 * 60 * 5) {
            return parsed;
          }
        }
        return null;
      }

      app.ports.storeUserCredentials.subscribe((x) => {
        console.log(`[storeUserCredentials] x = `, x);
        const { expiresIn, ...rest } = x;
        const expiresAt = new Date().getTime() + expiresIn;
        localStorage.setItem(
          "food-diary-cached-credentials",
          JSON.stringify({ ...rest, expiresAt })
        );
      });
    </script>
  </body>
</html>
